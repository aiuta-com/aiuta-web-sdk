name: Build and Deploy to Preprod and Prod on push to main

on:
  push:
    branches: [main]

jobs:
  build-and-deploy-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ğŸ”§ Setup project environment
        uses: ./.github/actions/setup-project.yml

      - name: ğŸ“¦ Build preprod project
        run: npm run build:preprod
        env:
          AIUTA_APP_PATH: sdk/main

      - name: ğŸš€ Deploy to Preprod
        uses: ./.github/actions/deploy-to-gcs.yml
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PREPROD }}
          bucket_name: aiuta_preprod_static
          destination_path: sdk/main/

      - name: ğŸ“¦ Build prod project
        run: npm run build
        env:
          AIUTA_APP_PATH: sdk/main

      - name: ğŸš€ Deploy to Prod
        uses: ./.github/actions/deploy-to-gcs.yml
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PROD }}
          bucket_name: aiuta_prod_static
          destination_path: sdk/main/

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Branch: main"
          echo "ğŸ“ Preprod uploaded to: aiuta_preprod_static/sdk/main/"
          echo "ğŸ“ Prod uploaded to: aiuta_prod_static/sdk/main/"
          echo ""
          echo "ğŸ”— Files available at:"
          echo ""
          echo "Preprod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- https://static.preprod.aiuta.com/sdk/main/${filename}"
          done
          echo ""
          echo "Prod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- https://static.aiuta.com/sdk/main/${filename}"
          done

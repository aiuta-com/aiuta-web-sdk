name: Build and Deploy to Preprod and Prod on push to main

on:
  push:
    branches: [main]

jobs:
  build-and-deploy-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # ===========================================
      # üì¶ PREPROD BUILD & DEPLOY
      # ===========================================
      - name: Build preprod project
        run: npm run build:preprod

      - name: Set up GCP credentials Preprod
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PREPROD }}

      - name: Upload SDK to GCS bucket Preprod
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/sdk/
          destination: aiuta_preprod_static/sdk/main/
          parent: false
          process_gcloudignore: 'false'

      - name: Upload APP to GCS bucket Preprod
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/app/
          destination: aiuta_preprod_static/sdk/main/
          parent: false
          process_gcloudignore: 'false'

      # ===========================================
      # üì¶ PROD BUILD & DEPLOY
      # ===========================================
      - name: Build prod project
        run: npm run build

      - name: Set up GCP credentials Prod
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PROD }}

      - name: Upload SDK to GCS bucket Prod
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/sdk/
          destination: aiuta_prod_static/sdk/main/
          parent: false
          process_gcloudignore: 'false'

      - name: Upload APP to GCS bucket Prod
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/app/
          destination: aiuta_prod_static/sdk/main/
          parent: false
          process_gcloudignore: 'false'

      # ===========================================
      # üìã DEPLOYMENT SUMMARY
      # ===========================================
      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üì¶ Branch: main"
          echo "üìÅ Preprod uploaded to: aiuta_preprod_static/sdk/main/"
          echo "üìÅ Prod uploaded to: aiuta_prod_static/sdk/main/"
          echo ""
          echo "üîó Files available at:"
          echo ""
          echo "Preprod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- https://static.preprod.aiuta.com/sdk/main/${filename}"
          done
          echo ""
          echo "Prod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- https://static.aiuta.com/sdk/main/${filename}"
          done

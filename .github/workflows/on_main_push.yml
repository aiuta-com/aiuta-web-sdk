name: Dev, Preprod and Prod on main

on:
  push:
    branches: [main]

jobs:
  build-and-deploy-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DEV_BUCKET: aiuta_dev_static
      DEV_URL: https://static.dev.aiuta.com
      PREPROD_BUCKET: aiuta_preprod_static
      PREPROD_URL: https://static.preprod.aiuta.com
      PROD_BUCKET: aiuta_prod_static
      PROD_URL: https://static.aiuta.com
      DEPLOY_PATH: sdk/main/

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup project environment
        uses: ./.github/actions/setup-project

      - name: üì¶ Build dev project
        run: npm run build:dev
        env:
          AIUTA_APP_PATH: ${{ env.DEPLOY_PATH }}

      - name: üöÄ Deploy to Dev
        uses: ./.github/actions/deploy-to-gcs
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_DEV }}
          bucket_name: ${{ env.DEV_BUCKET }}
          destination_path: ${{ env.DEPLOY_PATH }}

      - name: üì¶ Build preprod project
        run: npm run build:preprod
        env:
          AIUTA_APP_PATH: ${{ env.DEPLOY_PATH }}

      - name: üöÄ Deploy to Preprod
        uses: ./.github/actions/deploy-to-gcs
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PREPROD }}
          bucket_name: ${{ env.PREPROD_BUCKET }}
          destination_path: ${{ env.DEPLOY_PATH }}

      - name: üì¶ Build prod project
        run: npm run build
        env:
          AIUTA_APP_PATH: ${{ env.DEPLOY_PATH }}

      - name: üöÄ Deploy to Prod
        uses: ./.github/actions/deploy-to-gcs
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_PROD }}
          bucket_name: ${{ env.PROD_BUCKET }}
          destination_path: ${{ env.DEPLOY_PATH }}

      - name: üìã Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üì¶ Branch: main"
          echo "üìÅ Dev uploaded to: ${{ env.DEV_BUCKET }}/${{ env.DEPLOY_PATH }}"
          echo "üìÅ Preprod uploaded to: ${{ env.PREPROD_BUCKET }}/${{ env.DEPLOY_PATH }}"
          echo "üìÅ Prod uploaded to: ${{ env.PROD_BUCKET }}/${{ env.DEPLOY_PATH }}"
          echo ""
          echo "üîó Files available at:"
          echo ""
          echo "Dev:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- ${{ env.DEV_URL }}/${{ env.DEPLOY_PATH }}${filename}"
          done
          echo ""
          echo "Preprod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- ${{ env.PREPROD_URL }}/${{ env.DEPLOY_PATH }}${filename}"
          done
          echo ""
          echo "Prod:"
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- ${{ env.PROD_URL }}/${{ env.DEPLOY_PATH }}${filename}"
          done

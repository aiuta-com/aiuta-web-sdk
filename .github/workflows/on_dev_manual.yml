name: Build and Deploy to Dev on manual dispatch

on:
  workflow_dispatch:

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # ===========================================
      # 📦 DEV BUILD
      # ===========================================

      - name: Build dev project
        run: npm run build:dev
        env:
          AIUTA_APP_BRANCH: ${{ github.ref_name }}

      # ===========================================
      # 🚀 DEV DEPLOYMENT
      # ===========================================
      - name: Set up GCP credentials Dev
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_STATIC_UPLOADER_SA_KEY_JSON_DEV }}

      - name: Upload SDK to GCS bucket Dev
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/sdk/
          destination: aiuta_dev_static/sdk/${{ github.ref_name }}/
          parent: false
          process_gcloudignore: 'false'

      - name: Upload APP to GCS bucket Dev
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: dist/app/
          destination: aiuta_dev_static/sdk/${{ github.ref_name }}/
          parent: false
          process_gcloudignore: 'false'

      # ===========================================
      # 📋 DEPLOYMENT SUMMARY
      # ===========================================
      - name: Deployment Summary
        run: |
          echo "✅ Deployment completed successfully!"
          echo "📦 Branch: ${{ github.ref_name }}"
          echo "📁 Uploaded to: aiuta_dev_static/sdk/${{ github.ref_name }}/"
          echo ""
          echo "🔗 Files available at:"
          echo ""
          for file in dist/sdk/*; do
            filename=$(basename "$file")
            echo "- https://static.dev.aiuta.com/sdk/${{ github.ref_name }}/${filename}"
          done
